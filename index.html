<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เข้าสู่ระบบ | WHY CITY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden animate__animated animate__zoomIn">
        <div class="bg-orange-600 p-8 text-center text-white">
            <h1 class="text-3xl font-bold uppercase tracking-wider">WHY CITY</h1>
            <p class="opacity-80 mt-2">ระบบจัดการข้อมูลผู้เล่น</p>
        </div>
        
        <div class="p-8">
            <div class="mb-6 text-center text-gray-600 text-sm">
                กรุณายืนยันตัวตนผ่าน Discord เพื่อเข้าสู่ระบบ
            </div>
            
            <div class="space-y-3">
                <button onclick="loginWithDiscord()" class="flex items-center justify-center w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold py-3 px-4 rounded-xl transition-all shadow-lg transform hover:scale-[1.02] active:scale-95">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.862-1.297 1.199-1.99a.076.076 0 0 0-.041-.105 13.11 13.11 0 0 1-1.872-.89.077.077 0 0 1-.008-.128c.125-.094.249-.192.366-.291a.076.076 0 0 1 .08-.01c3.891 1.778 8.114 1.778 11.968 0a.076.076 0 0 1 .081.01c.117.099.241.197.366.29a.077.077 0 0 1-.008.129 13.103 13.103 0 0 1-1.872.891.076.076 0 0 0-.041.106c.337.691.737 1.36 1.199 1.99a.078.078 0 0 0 .084.028 19.83 19.83 0 0 0 6.023-3.03.077.077 0 0 0 .032-.057c.545-5.32-.823-9.825-3.585-13.66a.05.05 0 0 0-.033-.027zM8.02 15.33c-1.18 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.18 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    Login with Discord
                </button>
            </div>
            
            <p class="text-center text-xs text-gray-400 mt-6">
                ระบบความปลอดภัยโดย WHY CITY Developer Team
            </p>
        </div>
    </div>

<script>
    // --- 1. ส่วนการตั้งค่า (แก้ไขตรงนี้) ---
    const CONFIG = {
        CLIENT_ID: "1469383156322013259", 
        GUILD_ID: "1469387142152065027",
        ADMIN_ROLE_ID: "1469387208875180236", // ID Role ที่กดยอมรับได้
        // URL หน้าเว็บคุณ เช่น https://ชื่อคุณ.github.io/index.html
        REDIRECT_URI: window.location.origin + window.location.pathname 
    };

    // สร้างลิงก์สำหรับไปหน้าขออนุญาต Discord
    const DISCORD_AUTH_URL = `https://discord.com/api/oauth2/authorize?client_id=${CONFIG.CLIENT_ID}&redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&response_type=token&scope=identify%20guilds.members.read`;

    // --- 2. ฟังก์ชันหลัก ---

    // เมื่อกดปุ่ม Login
    function loginWithDiscord() {
        window.location.href = DISCORD_AUTH_URL;
    }

    // ฟังก์ชันเช็คการตอบกลับจาก Discord (ทำงานอัตโนมัติเมื่อโหลดหน้า)
    window.onload = async () => {
        const fragment = new URLSearchParams(window.location.hash.slice(1));
        const accessToken = fragment.get('access_token');

        if (accessToken) {
            try {
                // ดึงข้อมูล User (ชื่อ/รูป)
                const userRes = await fetch('https://discord.com/api/users/@me', {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const userData = await userRes.json();

                // ดึงข้อมูลสมาชิกในเซิร์ฟเวอร์เพื่อเช็ค Role
                const memberRes = await fetch(`https://discord.com/api/users/@me/guilds/${CONFIG.GUILD_ID}/member`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const memberData = await memberRes.json();

                // ล้างข้อมูลเก่า
                localStorage.clear();

                // ตรวจสอบว่ามี Role แอดมินหรือไม่
                if (memberData.roles && memberData.roles.includes(CONFIG.ADMIN_ROLE_ID)) {
                    // กรณีเป็น ADMIN
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userRole', 'admin');
                    localStorage.setItem('adminName', userData.username);
                    localStorage.setItem('adminAvatar', `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`);
                    
                    window.location.href = 'admin.html';
                } else {
                    // กรณีเป็น MEMBER ทั่วไป
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userRole', 'member');
                    localStorage.setItem('userName', userData.username);
                    localStorage.setItem('userAvatar', `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`);
                    
                    window.location.href = 'member.html';
                }
            } catch (error) {
                console.error("Login Error:", error);
                alert("ไม่สามารถดึงข้อมูลจาก Discord ได้ (อาจจะไม่ได้อยู่ในเซิร์ฟเวอร์ที่กำหนด)");
            }
        }
    };
</script>
</body>
</html>
